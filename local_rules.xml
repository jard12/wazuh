<group name="local,windows,sysmon,mail,">
  <!-- =========================
       SYSmon: File events
       ========================= -->
  <!-- FileCreate (ID 11) -->
  <rule id="100230" level="6">
    <field name="data.win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="data.win.system.eventID">11</field>
    <description>File created: $(data.win.eventdata.TargetFilename) by $(data.win.eventdata.Image) (user $(data.win.eventdata.User))</description>
    <group>file,create,sysmon,</group>
  </rule>

  <!-- Extra nadruk op Downloads & Program Files -->
  <rule id="100231" level="8">
    <if_sid>100230</if_sid>
    <regex type="pcre2">\\\\Users\\\\.*\\\\Downloads\\\\|^C:\\\\Program Files( \\(x86\\))?\\\\</regex>
    <description>Download/Install create: $(data.win.eventdata.TargetFilename) by $(data.win.eventdata.Image)</description>
    <group>download,install,sysmon,</group>
  </rule>

  <!-- FileCreateStreamHash (ID 15) -->
  <rule id="100232" level="4">
    <field name="data.win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="data.win.system.eventID">15</field>
    <description>File stream recorded: $(data.win.eventdata.TargetFilename) hashes=$(data.win.eventdata.Hashes)</description>
    <group>file,hash,sysmon,</group>
  </rule>

  <!-- FileDelete (ID 23) -->
  <rule id="100233" level="6">
    <field name="data.win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="data.win.system.eventID">23</field>
    <description>File deleted: $(data.win.eventdata.TargetFilename) by $(data.win.eventdata.Image)</description>
    <group>file,delete,sysmon,</group>
  </rule>

  <!-- FileDeleteDetected (ID 26) -->
  <rule id="100234" level="6">
    <field name="data.win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="data.win.system.eventID">26</field>
    <description>Permanently deleted: $(data.win.eventdata.TargetFilename) by $(data.win.eventdata.Image)</description>
    <group>file,delete,permanent,sysmon,</group>
  </rule>

  <!-- =========================
       SYSmon: DNS / Network
       ========================= -->
  <!-- DNS Query (ID 22) -->
  <rule id="100510" level="4">
    <field name="data.win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="data.win.system.eventID">22</field>
    <description>Sysmon DNS query: $(data.win.eventdata.QueryName) by $(data.win.eventdata.Image)</description>
    <group>dns,sysmon,</group>
  </rule>

  <!-- NetworkConnect (ID 3) -->
  <rule id="100511" level="5">
    <field name="data.win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="data.win.system.eventID">3</field>
    <description>Sysmon NetConnect: $(data.win.eventdata.Image) -> $(data.win.eventdata.DestinationHostname):$(data.win.eventdata.DestinationPort)</description>
    <group>network,sysmon,</group>
  </rule>

  <!-- Correlatie: DNS + NetConnect (zelfde agent, 60s) -->
  <rule id="100512" level="7" frequency="2" timeframe="60">
    <if_matched_sid>100510</if_matched_sid>
    <if_matched_sid>100511</if_matched_sid>
    <same_field>agent.id</same_field>
    <description>Web visit: $(data.win.eventdata.Image) -> $(data.win.eventdata.QueryName) ($(data.win.eventdata.DestinationIp):$(data.win.eventdata.DestinationPort))</description>
    <group>correlation,web,sysmon,</group>
  </rule>

  <!-- =========================
       Windows DNS-Client (native)
       ========================= -->
  <rule id="100540" level="4">
    <field name="data.win.system.providerName">Microsoft-Windows-DNS-Client</field>
    <field name="data.win.system.eventID">3008</field>
    <description>DNS query completed: $(data.win.eventdata.queryName) (status $(data.win.eventdata.queryStatus))</description>
    <group>dns,windows,</group>
  </rule>

  <!-- =========================
       PowerShell noise filter
       ========================= -->
  <rule id="199959" level="0">
    <field name="data.win.system.providerName">Microsoft-Windows-PowerShell</field>
    <field name="data.win.system.channel">Microsoft-Windows-PowerShell/Operational</field>
    <regex type="pcre2">(Set-StrictMode|Out-Default|PSConsoleHostReadLine|TabExpansion2|prompt|Get-FormatData)</regex>
    <description>Noise filter: benign PowerShell host lines</description>
  </rule>

  <!-- =========================
       Syscollector: program install/remove
       ========================= -->
  <rule id="100220" level="5">
    <field name="integration">syscollector</field>
    <field name="data.type">dbsync_programs</field>
    <field name="data.operation">INSERT</field>
    <description>Program installed: ${data.program.name} ${data.program.version}</description>
    <group>inventory,programs,install,</group>
  </rule>

  <rule id="100221" level="5">
    <field name="integration">syscollector</field>
    <field name="data.type">dbsync_programs</field>
    <field name="data.operation">DELETE</field>
    <description>Program removed: ${data.program.name} ${data.program.version}</description>
    <group>inventory,programs,remove,</group>
  </rule>

  <!-- =========================
       Sysmon Mail Detection
       ========================= -->
  <!-- Base: elke Sysmon NetConnect -->
  <rule id="100600" level="3">
    <field name="data.win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="data.win.system.eventID">3</field>
    <description>Sysmon NetConnect (base)</description>
    <group>network,sysmon,</group>
  </rule>

  <!-- SMTP -->
  <rule id="100601" level="5">
    <if_sid>100600</if_sid>
    <field name="data.win.eventdata.DestinationPort">25</field>
    <description>Outgoing SMTP 25: $(data.win.eventdata.Image) -> $(data.win.eventdata.DestinationHostname):$(data.win.eventdata.DestinationPort)</description>
    <group>mail,outgoing,sysmon,</group>
  </rule>
  <rule id="100602" level="5">
    <if_sid>100600</if_sid>
    <field name="data.win.eventdata.DestinationPort">465</field>
    <description>Outgoing SMTP 465: $(data.win.eventdata.Image) -> $(data.win.eventdata.DestinationHostname):$(data.win.eventdata.DestinationPort)</description>
    <group>mail,outgoing,sysmon,</group>
  </rule>
  <rule id="100603" level="5">
    <if_sid>100600</if_sid>
    <field name="data.win.eventdata.DestinationPort">587</field>
    <description>Outgoing SMTP 587: $(data.win.eventdata.Image) -> $(data.win.eventdata.DestinationHostname):$(data.win.eventdata.DestinationPort)</description>
    <group>mail,outgoing,sysmon,</group>
  </rule>

  <!-- IMAP/POP -->
  <rule id="100604" level="4">
    <if_sid>100600</if_sid>
    <field name="data.win.eventdata.DestinationPort">993</field>
    <description>IMAPS 993: $(data.win.eventdata.Image) -> $(data.win.eventdata.DestinationHostname):$(data.win.eventdata.DestinationPort)</description>
    <group>mail,incoming,sysmon,</group>
  </rule>
  <rule id="100605" level="4">
    <if_sid>100600</if_sid>
    <field name="data.win.eventdata.DestinationPort">995</field>
    <description>POP3S 995: $(data.win.eventdata.Image) -> $(data.win.eventdata.DestinationHostname):$(data.win.eventdata.DestinationPort)</description>
    <group>mail,incoming,sysmon,</group>
  </rule>
  <rule id="100606" level="4">
    <if_sid>100600</if_sid>
    <field name="data.win.eventdata.DestinationPort">143</field>
    <description>IMAP 143: $(data.win.eventdata.Image) -> $(data.win.eventdata.DestinationHostname):$(data.win.eventdata.DestinationPort)</description>
    <group>mail,incoming,sysmon,</group>
  </rule>
  <rule id="100607" level="4">
    <if_sid>100600</if_sid>
    <field name="data.win.eventdata.DestinationPort">110</field>
    <description>POP3 110: $(data.win.eventdata.Image) -> $(data.win.eventdata.DestinationHostname):$(data.win.eventdata.DestinationPort)</description>
    <group>mail,incoming,sysmon,</group>
  </rule>

  <!-- Correlatie: Sysmon DNS + SMTP -->
  <rule id="100640" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100510</if_matched_sid>
    <if_matched_sid>100601</if_matched_sid>
    <same_field>agent.id</same_field>
    <description>Mail correlation (Sysmon DNS + SMTP 25)</description>
    <group>mail,correlation,sysmon,</group>
  </rule>
  <rule id="100641" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100510</if_matched_sid>
    <if_matched_sid>100602</if_matched_sid>
    <same_field>agent.id</same_field>
    <description>Mail correlation (Sysmon DNS + SMTP 465)</description>
  </rule>
  <rule id="100642" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100510</if_matched_sid>
    <if_matched_sid>100603</if_matched_sid>
    <same_field>agent.id</same_field>
    <description>Mail correlation (Sysmon DNS + SMTP 587)</description>
  </rule>

  <!-- Correlatie: Windows DNS-Client + SMTP -->
  <rule id="100645" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100540</if_matched_sid>
    <if_matched_sid>100601</if_matched_sid>
    <same_field>agent.id</same_field>
    <description>Mail correlation (Windows DNS + SMTP 25)</description>
    <group>mail,correlation,windows,</group>
  </rule>
  <rule id="100646" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100540</if_matched_sid>
    <if_matched_sid>100602</if_matched_sid>
    <same_field>agent.id</same_field>
    <description>Mail correlation (Windows DNS + SMTP 465)</description>
  </rule>
  <rule id="100647" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100540</if_matched_sid>
    <if_matched_sid>100603</if_matched_sid>
    <same_field>agent.id</same_field>
    <description>Mail correlation (Windows DNS + SMTP 587)</description>
  </rule>

  <!-- =========================
       Security: "DA loggen" (groep membership)
       ========================= -->
  <!-- Lid toegevoegd aan (Domain) Admins/Administrators -->
  <rule id="100700" level="10">
    <field name="data.win.system.channel">Security</field>
    <field name="data.win.system.eventID">4728</field> <!-- global security group add -->
    <regex type="pcre2">(Domain Admins|Administrators)</regex>
    <description>Member ADDED to admin group: $(data.win.eventdata.MemberName) -> $(data.win.eventdata.TargetUserName)</description>
    <group>security,groupchange,admins,</group>
  </rule>
  <rule id="100701" level="10">
    <field name="data.win.system.channel">Security</field>
    <field name="data.win.system.eventID">4732</field> <!-- local security group add -->
    <regex type="pcre2">(Domain Admins|Administrators)</regex>
    <description>Member ADDED to local admin group: $(data.win.eventdata.MemberName) -> $(data.win.eventdata.TargetUserName)</description>
    <group>security,groupchange,admins,</group>
  </rule>

  <!-- Lid verwijderd uit (Domain) Admins/Administrators -->
  <rule id="100702" level="8">
    <field name="data.win.system.channel">Security</field>
    <field name="data.win.system.eventID">4729</field>
    <regex type="pcre2">(Domain Admins|Administrators)</regex>
    <description>Member REMOVED from admin group: $(data.win.eventdata.MemberName) -> $(data.win.eventdata.TargetUserName)</description>
    <group>security,groupchange,admins,</group>
  </rule>
  <rule id="100703" level="8">
    <field name="data.win.system.channel">Security</field>
    <field name="data.win.system.eventID">4733</field>
    <regex type="pcre2">(Domain Admins|Administrators)</regex>
    <description>Member REMOVED from local admin group: $(data.win.eventdata.MemberName) -> $(data.win.eventdata.TargetUserName)</description>
    <group>security,groupchange,admins,</group>
  </rule>
</group>
