<!-- =========================
     local_rules.xml  (Jard)
     ========================= -->

<!-- ========== SYSmon: File events (create / stream hash / delete) ========== -->
<group name="windows,sysmon,files,">

  <!-- FileCreate (ID 11) -->
  <rule id="100230" level="6">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">11</field>
    <description>File created: $(win.eventdata.TargetFilename) by $(win.eventdata.Image) (user $(win.eventdata.User))</description>
    <group>file,create,sysmon,</group>
  </rule>

  <!-- Extra nadruk op Downloads & Program Files -->
  <rule id="100231" level="8">
    <if_sid>100230</if_sid>
    <regex type="pcre2">\\\\Users\\\\.*\\\\Downloads\\\\|^C:\\\\Program Files( \\(x86\\))?\\\\</regex>
    <description>Download/Install create: $(win.eventdata.TargetFilename) by $(win.eventdata.Image)</description>
    <group>download,install,sysmon,</group>
  </rule>

  <!-- FileCreateStreamHash (ID 15) -->
  <rule id="100232" level="4">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">15</field>
    <description>File stream recorded: $(win.eventdata.TargetFilename) hashes=$(win.eventdata.Hashes)</description>
    <group>file,hash,sysmon,</group>
  </rule>

  <!-- FileDelete (ID 23) -->
  <rule id="100233" level="6">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">23</field>
    <description>File deleted: $(win.eventdata.TargetFilename) by $(win.eventdata.Image)</description>
    <group>file,delete,sysmon,</group>
  </rule>

  <!-- FileDeleteDetected (ID 26) -->
  <rule id="100234" level="6">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">26</field>
    <description>Permanently deleted: $(win.eventdata.TargetFilename) by $(win.eventdata.Image)</description>
    <group>file,delete,permanent,sysmon,</group>
  </rule>

</group>

<!-- =============== SYSmon: Process & Network & DNS ================= -->
<group name="sysmon,windows,">

  <!-- DNS Query (ID 22) -->
  <rule id="100510" level="4">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">22</field>
    <description>Sysmon DNS query: $(win.eventdata.QueryName) by $(win.eventdata.Image)</description>
    <group>dns,sysmon,</group>
  </rule>

  <!-- NetworkConnect (ID 3) -->
  <rule id="100511" level="5">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">3</field>
    <description>Sysmon NetConnect: $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>network,sysmon,</group>
  </rule>

  <!-- Correlatie: DNS + NetConnect binnen 60 sec (zelfde agent) -->
  <rule id="100512" level="7" frequency="2" timeframe="60">
    <if_matched_sid>100510</if_matched_sid>
    <if_matched_sid>100511</if_matched_sid>
    <same_field>agent.id</same_field>
    <description>Web visit: $(win.eventdata.Image) → $(win.eventdata.QueryName) ($(win.eventdata.DestinationIp):$(win.eventdata.DestinationPort))</description>
    <group>correlation,web,sysmon,</group>
  </rule>

</group>

<!-- =============== Windows DNS-Client (native kanaal) ================= -->
<group name="dns,windows,">
  <rule id="100540" level="4">
    <field name="win.system.providerName">Microsoft-Windows-DNS-Client</field>
    <field name="win.system.eventID">3008</field>
    <description>DNS query completed: $(win.eventdata.queryName) (status $(win.eventdata.queryStatus))</description>
    <group>dns,windows,</group>
  </rule>
</group>

<!-- =============== PowerShell ruisfilter (optioneel) ================== -->
<group name="windows,powershell,global,">
  <rule id="199959" level="0">
    <if_group>eventchannel</if_group>
    <regex type="pcre2">(Set-StrictMode|Out-Default|PSConsoleHostReadLine|TabExpansion2|prompt|Get-FormatData)</regex>
    <description>Noise filter: benign PowerShell host lines</description>
  </rule>
</group>

<!-- =============== Syscollector: program install/remove ================== -->
<group name="local,syscollector,">
  <!-- Install -->
  <rule id="100220" level="5">
    <field name="integration">syscollector</field>
    <field name="data.type">dbsync_programs</field>
    <field name="data.operation">INSERT</field>
    <description>Program installed: ${data.program.name} ${data.program.version}</description>
    <group>inventory,programs,install,</group>
  </rule>

  <!-- Remove -->
  <rule id="100221" level="5">
    <field name="integration">syscollector</field>
    <field name="data.type">dbsync_programs</field>
    <field name="data.operation">DELETE</field>
    <description>Program removed: ${data.program.name} ${data.program.version}</description>
    <group>inventory,programs,remove,</group>
  </rule>
</group>

<!-- =========================
     Sysmon Mail Detection (Jard)
     ========================= -->
<group name="sysmon,network,mail,">

  <!-- Outgoing SMTP (poort 25, 465, 587) -->
  <rule id="100620" level="5">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">3</field>
    <regex type="pcre2">DestinationPort="(25|465|587)"</regex>
    <description>Outgoing SMTP connection: $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>mail,outgoing,sysmon,</group>
  </rule>

  <!-- Incoming IMAP/POP3 -->
  <rule id="100621" level="4">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">3</field>
    <regex type="pcre2">DestinationPort="(993|995|143|110)"</regex>
    <description>Mail client connection (IMAP/POP3): $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>mail,incoming,sysmon,</group>
  </rule>

  <!-- Mail attachment creation -->
  <rule id="100622" level="5">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">11</field>
    <regex type="pcre2">\\(Downloads|Attachments|AppData\\Local\\Temp)\\.*\.(eml|msg|pdf|docx|zip)</regex>
    <description>Mail-related file created: $(win.eventdata.TargetFilename) by $(win.eventdata.Image)</description>
    <group>mail,attachment,sysmon,</group>
  </rule>

</group>
