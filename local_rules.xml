<!-- =========================
     local_rules.xml 
     ========================= -->

<!-- ========== SYSmon: File events (create / stream hash / delete) ========== -->
<group name="windows,sysmon,files,">

  <!-- FileCreate (ID 11) -->
  <rule id="100230" level="6">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">11</field>
    <description>File created: $(win.eventdata.TargetFilename) by $(win.eventdata.Image) (user $(win.eventdata.User))</description>
    <group>file,create,sysmon,</group>
  </rule>

  <!-- Extra nadruk op Downloads & Program Files -->
  <rule id="100231" level="8">
    <if_sid>100230</if_sid>
    <regex type="pcre2">\\\\Users\\\\.*\\\\Downloads\\\\|^C:\\\\Program Files( \\(x86\\))?\\\\</regex>
    <description>Download/Install create: $(win.eventdata.TargetFilename) by $(win.eventdata.Image)</description>
    <group>download,install,sysmon,</group>
  </rule>

  <!-- FileCreateStreamHash (ID 15) -->
  <rule id="100232" level="4">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">15</field>
    <description>File stream recorded: $(win.eventdata.TargetFilename) hashes=$(win.eventdata.Hashes)</description>
    <group>file,hash,sysmon,</group>
  </rule>

  <!-- FileDelete (ID 23) -->
  <rule id="100233" level="6">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">23</field>
    <description>File deleted: $(win.eventdata.TargetFilename) by $(win.eventdata.Image)</description>
    <group>file,delete,sysmon,</group>
  </rule>

  <!-- FileDeleteDetected (ID 26) -->
  <rule id="100234" level="6">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">26</field>
    <description>Permanently deleted: $(win.eventdata.TargetFilename) by $(win.eventdata.Image)</description>
    <group>file,delete,permanent,sysmon,</group>
  </rule>

</group>

<!-- =============== SYSmon: Process & Network & DNS ================= -->
<group name="sysmon,windows,">

  <!-- DNS Query (ID 22) -->
  <rule id="100510" level="4">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">22</field>
    <description>Sysmon DNS query: $(win.eventdata.QueryName) by $(win.eventdata.Image)</description>
    <group>dns,sysmon,</group>
  </rule>

  <!-- NetworkConnect (ID 3) -->
  <rule id="100511" level="5">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">3</field>
    <description>Sysmon NetConnect: $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>network,sysmon,</group>
  </rule>

  <!-- Correlatie: DNS + NetConnect binnen 60 sec (zelfde agent) -->
  <rule id="100512" level="7" frequency="2" timeframe="60">
    <if_matched_sid>100510</if_matched_sid>
    <if_matched_sid>100511</if_matched_sid>
    <same_field>agent.id</same_field>
    <description>Web visit: $(win.eventdata.Image) → $(win.eventdata.QueryName) ($(win.eventdata.DestinationIp):$(win.eventdata.DestinationPort))</description>
    <group>correlation,web,sysmon,</group>
  </rule>

</group>

<!-- =============== Windows DNS-Client (native kanaal) ================= -->
<group name="dns,windows,">
  <rule id="100540" level="4">
    <field name="win.system.providerName">Microsoft-Windows-DNS-Client</field>
    <field name="win.system.eventID">3008</field>
    <description>DNS query completed: $(win.eventdata.queryName) (status $(win.eventdata.queryStatus))</description>
    <group>dns,windows,</group>
  </rule>
</group>

<group name="windows,powershell,global,">
  <rule id="199959" level="0">
    <field name="win.system.providerName">Microsoft-Windows-PowerShell</field>
    <field name="win.system.channel">Microsoft-Windows-PowerShell/Operational</field>
    <regex type="pcre2">(Set-StrictMode|Out-Default|PSConsoleHostReadLine|TabExpansion2|prompt|Get-FormatData)</regex>
    <description>Noise filter: benign PowerShell host lines</description>
  </rule>
</group>

<!-- =============== Syscollector: program install/remove ================== -->
<group name="local,syscollector,">
  <!-- Install -->
  <rule id="100220" level="5">
    <field name="integration">syscollector</field>
    <field name="data.type">dbsync_programs</field>
    <field name="data.operation">INSERT</field>
    <description>Program installed: ${data.program.name} ${data.program.version}</description>
    <group>inventory,programs,install,</group>
  </rule>

  <!-- Remove -->
  <rule id="100221" level="5">
    <field name="integration">syscollector</field>
    <field name="data.type">dbsync_programs</field>
    <field name="data.operation">DELETE</field>
    <description>Program removed: ${data.program.name} ${data.program.version}</description>
    <group>inventory,programs,remove,</group>
  </rule>
</group>

<!-- =========================
     Sysmon Mail Detection (final)
     ========================= -->
<group name="sysmon,network,mail,">

  <!-- Basis: elke Sysmon NetConnect -->
  <rule id="100600" level="3">
    <field name="win.system.providerName">Microsoft-Windows-Sysmon</field>
    <field name="win.system.eventID">3</field>
    <description>Sysmon NetConnect (base)</description>
    <group>network,sysmon,</group>
  </rule>

  <!-- SMTP -->
  <rule id="100601" level="5">
    <if_sid>100600</if_sid>
    <field name="win.eventdata.DestinationPort">25</field>
    <description>Outgoing SMTP (25): $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>mail,outgoing,sysmon,</group>
  </rule>
  <rule id="100602" level="5">
    <if_sid>100600</if_sid>
    <field name="win.eventdata.DestinationPort">465</field>
    <description>Outgoing SMTP (SSL 465): $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>mail,outgoing,sysmon,</group>
  </rule>
  <rule id="100603" level="5">
    <if_sid>100600</if_sid>
    <field name="win.eventdata.DestinationPort">587</field>
    <description>Outgoing SMTP (TLS 587): $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>mail,outgoing,sysmon,</group>
  </rule>

  <!-- IMAP/POP -->
  <rule id="100604" level="4">
    <if_sid>100600</if_sid>
    <field name="win.eventdata.DestinationPort">993</field>
    <description>IMAPS (993): $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>mail,incoming,sysmon,</group>
  </rule>
  <rule id="100605" level="4">
    <if_sid>100600</if_sid>
    <field name="win.eventdata.DestinationPort">995</field>
    <description>POP3S (995): $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>mail,incoming,sysmon,</group>
  </rule>
  <rule id="100606" level="4">
    <if_sid>100600</if_sid>
    <field name="win.eventdata.DestinationPort">143</field>
    <description>IMAP (143): $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>mail,incoming,sysmon,</group>
  </rule>
  <rule id="100607" level="4">
    <if_sid>100600</if_sid>
    <field name="win.eventdata.DestinationPort">110</field>
    <description>POP3 (110): $(win.eventdata.Image) → $(win.eventdata.DestinationHostname):$(win.eventdata.DestinationPort)</description>
    <group>mail,incoming,sysmon,</group>
  </rule>

</group>


<!-- =========================
     Correlatie: Mail ↔ DNS (Sysmon DNS 100510)
     ========================= -->
<group name="correlation,mail,sysmon,">
  <rule id="100640" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100510</if_matched_sid>  <!-- Sysmon DNS -->
    <if_matched_sid>100601</if_matched_sid>  <!-- SMTP 25 -->
    <same_field>agent.id</same_field>
    <description>Mail domain lookup (Sysmon DNS) + SMTP 25</description>
    <group>mail,correlation,sysmon,</group>
  </rule>
  <rule id="100641" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100510</if_matched_sid>
    <if_matched_sid>100602</if_matched_sid>  <!-- SMTP 465 -->
    <same_field>agent.id</same_field>
    <description>Mail domain lookup (Sysmon DNS) + SMTP 465</description>
  </rule>
  <rule id="100642" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100510</if_matched_sid>
    <if_matched_sid>100603</if_matched_sid>  <!-- SMTP 587 -->
    <same_field>agent.id</same_field>
    <description>Mail domain lookup (Sysmon DNS) + SMTP 587</description>
  </rule>
</group>

<!-- =========================
     Correlatie: Mail ↔ DNS (Windows DNS-Client 100540)
     ========================= -->
<group name="correlation,mail,windowsdns,">
  <rule id="100645" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100540</if_matched_sid>  <!-- Windows DNS-Client -->
    <if_matched_sid>100601</if_matched_sid>  <!-- SMTP 25 -->
    <same_field>agent.id</same_field>
    <description>Mail domain lookup (Windows DNS) + SMTP 25</description>
    <group>mail,correlation,</group>
  </rule>
  <rule id="100646" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100540</if_matched_sid>
    <if_matched_sid>100602</if_matched_sid>  <!-- SMTP 465 -->
    <same_field>agent.id</same_field>
    <description>Mail domain lookup (Windows DNS) + SMTP 465</description>
  </rule>
  <rule id="100647" level="7" frequency="2" timeframe="300">
    <if_matched_sid>100540</if_matched_sid>
    <if_matched_sid>100603</if_matched_sid>  <!-- SMTP 587 -->
    <same_field>agent.id</same_field>
    <description>Mail domain lookup (Windows DNS) + SMTP 587</description>
  </rule>
</group>
